---
title: "Data Cleaning and Preliminary Analyses"
output: html_notebook
---

This document is where I will perform preliminary analyses to investigate my data. I will also conduct data cleaning necessary to conduct these analyses. 

Outline:

Data Cleaning:
0. Load in the data and necessary packages
1. Clean the data 
2. Calculate necessary parameters (development time in days not dates, ln(mass))
3. Get data into long format for making cumulative growth curve graphs

Growth Analyses:
4. Run models for mass gain and development time with diet and parasitization status as fixed effects, and bin as a random effect
5. Graph growth curves (ln-transformed) for total development
6. Plot mass and development time at wandering raw data, to map onto Geoff and I's study predictions

Wasp Analyses:
7. Run models for wasp survival to eclosion with diet, number of times parasitized, and wetness as fixed effects, and bin as a random effect
8. Graph boxplots for eclosion percentage across diet type 

# Data Cleaning

## 0. Load in the data and necessary packages

```{r}
library(ggplot2)
library(plyr)
library(dplyr)
library(lme4)
library(lubridate)
library(tidyr)
library(Rmisc)
library(lmerTest)
```

```{r}
data <- read.csv("~/Desktop/MsCcSurvJun2.csv", header = TRUE)
```

## 1. Clean the data

### Eliminate those that died:

```{r}
data <- data[data$survived == "yes", ]
```

### Eliminate failed parasitizations:

```{r}

data %>%
  filter((data$para == "yes" & data$mass.w != "NA"))

data <- data[data$ID != 34, ]
data <- data[data$ID != 36, ]
data <- data[data$ID != 102, ]
data <- data[data$ID != 124, ]

```


### Checking sample sizes

```{r}
count(data[data$food == "DC" & data$para == "yes", ])
count(data[data$food == "DC" & data$para == "no", ])
count(data[data$food == "TB" & data$para == "yes", ])
count(data[data$food == "TB" & data$para == "no", ])
count(data[data$food == "diet" & data$para == "yes", ])
count(data[data$food == "diet" & data$para == "no", ])
```

## 2. Calculate necessary parameters

### Convert dates to experiment days 

```{r}
# Internal process of the loop to convert days to dates
expt_day <- function(start.date, date){
  date <- mdy(date)
  start <- mdy(start.date)
  diff <- yday(date) - yday(start)

  return(diff)
}

# Code for the loop itself
loop <- function(start.date, date.list){
  days <- rep(NA, length(date.list))
  for (i in 1:(length(days))){
    days[i] <- expt_day(start.date = start.date, date = date.list[i])
  }
  return(days)
}

# Run the loop for the various dates listed

data$day.hatch <- loop(start.date = "04/21/2020", date.list = data$date.hatch)
data$day.3rd <- loop(start.date = "04/21/2020", date.list = data$date.3rd)
data$day.para <- loop(start.date = "04/21/2020", date.list = data$date.para)
data$day.4th <- loop(start.date = "04/21/2020", date.list = data$date.4th)
data$day.5th <- loop(start.date = "04/21/2020", date.list = data$date.5th)
data$day.w <- loop(start.date = "04/21/2020", date.list = data$date.w)
data$day.eclos <- loop(start.date = "04/21/2020", date.list = data$date.eclos)
data$day.coc <- loop(start.date = "04/21/2020", date.list = data$date.coc)
data$day.remove <- loop(start.date = "04/21/2020", date.list = data$date.remove)
data$day.w.eclos <- loop(start.date = "04/21/2020", date.list = data$date.w.eclos)

```

### Calculate development times

```{r}
# Time til each instar
data$tth <- 0
data$tt3 <- data$day.3rd - data$day.hatch
data$tt4 <- data$day.4th - data$day.hatch
data$tt5 <- data$day.5th - data$day.hatch
data$ttw <- data$day.w - data$day.hatch
data$ttcoc <- data$day.coc - data$day.hatch
data$ttweclos <- data$day.w.eclos - data$day.hatch

# Time spent in each instar
data$delta3 <- data$day.4th - data$day.3rd
data$delta4 <- data$day.5th - data$day.4th
data$delta5 <- data$day.w - data$day.5th

```

### Convert masses to ln(mass)

```{r}
data$lnh <- log(data$mass.hatch)
data$ln3 <- log(data$mass.3rd)
data$ln4 <- log(data$mass.4th)
data$ln5 <- log(data$mass.5th)
data$lnw <- log(data$mass.w)
```

## 3. Convert to long format for graphing

### Converting to long format

```{r}
masslong <- data %>% gather(instar, mass, lnh, ln3, ln4, ln5, lnw)
masslong$instar <- gsub("ln", "", masslong$instar)

agelong <- data %>% gather(instar, age, tth, tt3, tt4, tt5, ttw)
agelong$instar <- gsub("tt", "", agelong$instar)

masslong <- masslong %>% select(ID, food, para, instar, mass)
agelong <- agelong %>% select(ID, food, para, instar, age)

datalong<-merge(masslong, agelong, by=c("ID", "food", "para", "instar"))

```

### Finding means (not separated by para status) 

```{r}
#calculate means and variation

#constructing summarySE for age and mass to make mean plot

masssum <- summarySE(datalong, measurevar = "mass",
                  groupvars = c("food", "instar"),
                  na.rm=TRUE)

agesum <- summarySE(datalong, measurevar = "age",
                   groupvars = c("food", "instar"),
                   na.rm = TRUE)

#combine into one data frame

means <- masssum

means$age <- agesum[, 4]
means$age.se <- agesum[, 6]
means$age.ci <- agesum[, 7]

```

### Finding means (separated by para status) 

```{r}
#calculate means and variation

#constructing summarySE for age and mass to make mean plot

pmasssum <- summarySE(datalong, measurevar = "mass",
                  groupvars = c("food", "para", "instar"),
                  na.rm=TRUE)

pagesum <- summarySE(datalong, measurevar = "age",
                   groupvars = c("food", "para", "instar"),
                   na.rm = TRUE)

#combine into one data frame

pmeans <- pmasssum

pmeans$age <- pagesum[, 5]
pmeans$age.se <- pagesum[, 7]
pmeans$age.ci <- pagesum[, 8]

```

# Growth Analyses:

## 4. Run models for mass gain and development time with diet as a fixed effect, and bin as a random effect

### Change 0s to NAs for bin on diet individuals

```{r}
data$bin <- gsub("0", "", data$bin)
```

### Mass at wandering 

```{r}
mw1 <- lmer(mass.w ~ food + (1|bin), data = data[data$para == "no", ])

summary(mw1)

```

### Time til wandering

```{r}
tw1 <- lmer(day.w ~ food + (1|bin), data = data[data$para == "no", ])

summary(tw1)

```

### Mass at 5th instar

```{r}
m51 <- lmer(mass.5th ~ food*para + (1|bin), data = data)

summary(m51)
```


### Time til 5th instar

```{r}
t51 <- lmer(day.5th ~ food*para + (1|bin), data = data)

summary(t51)
```


## 5. Graph growth curves (ln-transformed) for total development

### Combined with CIs

```{r}

meanplot <- ggplot(means, aes(x = age, y = mass, group = food, color = food)) + 
  geom_point(size = 3) + 
  geom_line(size = 1.2) + 
  geom_errorbar(aes(ymin = mass-(ci/2), ymax = mass + (ci/2)),
                width = .3, size = 1) + 
  geom_errorbarh(aes(xmin = age - (age.ci/2), xmax = age + (age.ci/2)),
                 height = .3, size = 1) + 
  scale_color_manual(values=c("#95D840", "#1F9F88", "#3F87BC"),
                     name="Food Type",
                     label=c("Devil's Claw", "Diet", "Tobacco")) + 
  labs(x = "Total developmental age (days)", y = "Total mass gained ln(mg)")


ggsave("MsCcSurvJun2.png", width = 8, height = 5)

meanplot


```



### Separated para and non-para

```{r}

pmeanplot <- ggplot(pmeans, aes(x = age, y = mass, color = food, shape = para)) + 
  geom_point(size = 3) + 
  geom_line(size = 1.2, aes(linetype = para)) + 
  geom_errorbar(aes(ymin = mass-(ci/2), ymax = mass + (ci/2)),
                width = .3, size = 1) + 
  geom_errorbarh(aes(xmin = age - (age.ci/2), xmax = age + (age.ci/2)),
                 height = .3, size = 1) + 
  scale_color_manual(values=c("#95D840", "#1F9F88", "#3F87BC"),
                     name="Food Type",
                     label=c("Devil's Claw", "Diet", "Tobacco")) + 
  scale_shape_manual(values = c(2, 19)) + 
  labs(x = "Total developmental age (days)", y = "Total mass gained ln(mg)")


ggsave("MsCcSurvParaJun2.png", width = 8, height = 5)

pmeanplot


```




## 6. Plot mass and development time at wandering raw data, to map onto Geoff and I's study predictions

```{r}
raw <- ggplot(data, aes(x = ttw, y = mass.w, color = food)) + 
  geom_point(alpha = 0.8) + 
  scale_color_manual(values=c("#95D840", "#1F9F88", "#3F87BC"),
                     name="Food Type",
                     label=c("Devil's Claw", "Diet", "Tobacco")) + 
  labs(x = "Age at wandering (days)", y = "Mass at wandering (mg)")

ggsave("MsCcSurvRawJun2.png")

raw
```

## 7. Parasitoid Models

### Time til parasitoid emergence

```{r}
te1 <- lmer(day.coc ~ food + (1|bin), data = data[data$para == "yes", ])

summary(te1)
```

### Number of wasps emerged

```{r}
we1 <- lmer(num.w.coc ~ food + (1|bin), data = data[data$para == "yes", ])

summary(we1)

```


### Percent wasps eclosed
